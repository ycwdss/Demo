define(["jquery"],function(){~function($){var patterns,fields,errorElement,addErrorClass,removeErrorClass,novalidate,validateForm,validate,validateFields,removeFromUnvalidFields,asyncValidate,getVal,aorbValidate,validateReturn,unvalidFields=[];patterns={email:function(text){return/^(?:[a-z0-9]+[_\-+.]+)*[a-z0-9]+@(?:([a-z0-9]+-?)*[a-z0-9]+.)+([a-z]{2,})+$/i.test(text)},date:function(text){var reg=/^([1-2]\d{3})([-/.])?(1[0-2]|0?[1-9])([-/.])?([1-2]\d|3[01]|0?[1-9])$/,taste,d,year,month,day;if(!reg.test(text)){return false}taste=reg.exec(text);year=+taste[1];month=+taste[3]-1;day=+taste[5];d=new Date(year,month,day);return year===d.getFullYear()&&month===d.getMonth()&&day===d.getDate()},mobile:function(text){return/^1[3-9]\d{9}$/.test(text)},tel:function(text){return/^(?:(?:0\d{2,3}[- ]?[1-9]\d{6,7})|(?:[48]00[- ]?[1-9]\d{6}))$/.test(text)},number:function(input){var min=$.trim(this.$item.attr("min")),max=$.trim(this.$item.attr("max")),result=/^\-?(?:[1-9]\d*|0)(?:[.]\d+)?$/.test(input),text=+input,step=$.trim(this.$item.attr("step"));min=min===""||isNaN(min)?text-1:+min;max=max===""||isNaN(max)?text+1:+max;step=step===""||isNaN(step)?0:+step;return result&&(0>=step?text>=min&&text<=max:0===(text+min)%step&&(text>=min&&text<=max))},range:function(text){return this.number(text)},url:function(){var protocols="((https?|s?ftp|irc[6s]?|git|afp|telnet|smb):\\/\\/)?",userInfo="([a-z0-9]\\w*(\\:[\\S]+)?\\@)?",domain="(?:localhost|(?:[a-z0-9]+(?:[-\\w]*[a-z0-9])?(?:\\.[a-z0-9][-\\w]*[a-z0-9])*)*\\.[a-z]{2,})",port="(:\\d{1,5})?",ip="\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}",address="(\\/\\S*)?",domainType=[protocols,userInfo,domain,port,address],ipType=[protocols,userInfo,ip,port,address],rDomain=new RegExp("^"+domainType.join("")+"$","i"),rIP=new RegExp("^"+ipType.join("")+"$","i");return function(text){return rDomain.test(text)||rIP.test(text)}}(),password:function(text){return this.text(text)},checkbox:function(){return patterns._checker("checkbox")},radio:function(){return patterns._checker("radio")},_checker:function(type){var form=this.$item.parents("form").eq(0),identifier="input[type="+type+'][name="'+this.$item.attr("name")+'"]',result=false,$items=$(identifier,form);$items.each(function(i,item){if(item.checked&&!result){return result=true}});return result},text:function(text){if(!(text=$.trim(text)).length)return;var max=parseInt(this.$item.attr("maxlength"),10),min=parseInt(this.$item.attr("minlength"),10),range;range=function(){var ret=true,length=text.length;if(min)ret=length>=min;if(max)ret=ret&&length<=max;return ret};return range()}};asyncValidate=function($item,klass,isErrorOnParent){var data=$item.data(),url=data.url,method=data.method||"get",key=data.key||"key",text=getVal($item),params={};params[key]=text;$[method](url,params).success(function(isValidate){var message=isValidate?"IM VALIDED":"unvalid";return validateReturn.call(this,$item,klass,isErrorOnParent,message)}).error(function(){})};aorbValidate=function($item,klass,isErrorOnParent){var id=$item.data("aorb")==="a"?"b":"a",$pair=$("[data-aorb="+id+"]",$item.parents("form").eq(0)),a=[$item,klass,isErrorOnParent],b=[$pair,klass,isErrorOnParent],result=0;result+=validateReturn.apply(this,a)?0:1;result+=validateReturn.apply(this,b)?0:1;result=result>0?(removeErrorClass.apply(this,a),removeErrorClass.apply(this,b),false):validateReturn.apply(this,a.concat("unvalid"));return result};validateReturn=function($item,klass,parent,message){if(!$item){return"DONT VALIDATE UNEXIST ELEMENT"}var pattern,type,val,ret,event;pattern=$item.attr("pattern");pattern&&pattern.replace("\\","\\\\");type=$item.attr("type")||"text";type=patterns[type]?type:"text";val=$.trim(getVal($item));event=$item.data("event");message=message?message:pattern?new RegExp(pattern).test(val)||"unvalid":patterns[type](val)||"unvalid";if(message==="unvalid"){removeErrorClass($item,klass,parent)}return/^(?:unvalid|empty)$/.test(message)?(ret={$el:addErrorClass.call(this,$item,klass,parent,message),type:type,error:message},$item.trigger("after:"+event,$item),ret):(removeErrorClass.call(this,$item,klass,parent),$item.trigger("after:"+event,$item),false)};fields=function(identifie,form){return $(identifie,form)};getVal=function($item){return $item.val()||($item.is("[contenteditable]")?$item.text():"")};validate=function($item,klass,parent){var async,aorb,type,val,commonArgs,event;patterns.$item=$item;type=$item.attr("type");val=getVal($item);async=$item.data("url");aorb=$item.data("aorb");event=$item.data("event");commonArgs=[$item,klass,parent];event&&$item.trigger("before:"+event,$item);if(!(/^(?:radio|checkbox)$/.test(type)||aorb)&&!patterns.text(val)){return validateReturn.call(this,$item,klass,parent,val.length?"unvalid":"empty")}if(aorb){return aorbValidate.apply(this,commonArgs)}if(async){return asyncValidate.apply(this,commonArgs)}return validateReturn.call(this,$item,klass,parent)};validateFields=function($fields,method,klass,parent){var reSpecialType=/^radio|checkbox/,field;$.each($fields,function(i,f){$(f).on(reSpecialType.test(f.type)||"SELECT"===f.tagName?"change blur":method,function(){var $items=$(this);if(reSpecialType.test(this.type)){$items=$("input[type="+this.type+"][name="+this.name+"]",$items.closest("form"))}$items.each(function(){(field=validate.call(this,$(this),klass,parent))&&unvalidFields.push(field)})})})};validateForm=function($fields,method,klass,parent){if(method&&!validateFields.length){return true}unvalidFields=$.map($fields,function(el){var field=validate.call(null,$(el),klass,parent);if(field){return field}});return validateFields.length?unvalidFields:false};removeFromUnvalidFields=function($item){var obj,index;obj=$.grep(unvalidFields,function(item){return item.$el=$item})[0];if(!obj){return}index=$.inArray(obj,unvalidFields);unvalidFields.splice(index,1);return unvalidFields};errorElement=function($item,parent){return $item.data("parent")?$item.closest($item.data("parent")):parent?$item.parent():$item};addErrorClass=function($item,klass,parent,emptyClass){return errorElement($item,parent).addClass(klass+" "+emptyClass)};removeErrorClass=function($item,klass,parent){removeFromUnvalidFields.call(this,$item);return errorElement($item,parent).removeClass(klass+" empty unvalid")};novalidate=function($form){return $form.attr("novalidate")||$form.attr("novalidate","true")};$.fn.validator=function(_options){var $form=this,options=_options||{},identifie=options.identifie||"[required]",klass=options.error||"error",isErrorOnParent=options.isErrorOnParent||false,method=options.method||"blur",before=options.before||function(){return true},after=options.after||function(){return true},errorCallback=options.errorCallback||function(){},$items=fields(identifie,$form);novalidate($form);method&&validateFields.call(this,$items,method,klass,isErrorOnParent);$form.on("focusin",identifie,function(){removeErrorClass.call(this,$(this),"error unvalid empty",isErrorOnParent)});$form.on("submit",function(e){before.call(this,$items);validateForm.call(this,$items,method,klass,isErrorOnParent);return unvalidFields.length?(e.preventDefault(),errorCallback.call(this,unvalidFields)):after.call(this,e,$items)})}}(window.jQuery||window.Zepto)});